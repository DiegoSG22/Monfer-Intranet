{% extends 'odontologia/dashboard.html' %}
{% load static %}

{% block title %}Mi Perfil{% endblock %}

{% block extra_head %}
    <style>
        /* Estilos específicos para el perfil, si los hay, aunque muchos vendrán del dashboard */
        .profile-pic-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 3px solid var(--border-color); /* Usamos variable del tema */
        }
        /* Si tienes un tema oscuro, podrías ajustar el borde */
        [data-bs-theme="dark"] .profile-pic-preview {
            border-color: #e83e8c; /* Color del sidebar-active-bg para el borde en dark mode */
        }
        .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        .invalid-feedback {
            display: block; /* Asegura que se muestre */
            color: #dc3545;
            margin-top: 0.25rem;
            font-size: 0.875em;
        }
    </style>
{% endblock %}

{% block main_content_body %}
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header card-header-pink d-flex justify-content-between align-items-center">
                    <h3 class="mb-0 text-white">Mi Perfil</h3> {# Aseguramos texto blanco #}
                    <a href="{% url 'dashboard' %}" class="btn btn-sm btn-light">Volver al Panel</a> {# Botón claro para contraste #}
                </div>
                <div class="card-body">
                    {# Los mensajes de Django se mostrarán automáticamente por la plantilla base del dashboard #}

                    <form method="post" action="{% url 'editar_perfil' %}" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="text-center mb-4">
                            {% if doctor_form.instance.foto_perfil %}
                                <img src="{{ doctor_form.instance.foto_perfil.url }}" alt="Foto de perfil actual" class="profile-pic-preview">
                            {% else %}
                                {# Placeholder si no hay foto. Asegúrate de tener 'images/doctor_placeholder.png' #}
                                <img src="{% static 'images/doctor_placeholder.png' %}" alt="Sin foto de perfil" class="profile-pic-preview">
                            {% endif %}
                        </div>

                        <h4 class="h5 mb-3">Datos Personales</h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ user_form.first_name.id_for_label }}" class="form-label">{{ user_form.first_name.label }}</label>
                                {{ user_form.first_name }}
                                {% if user_form.first_name.errors %}<div class="invalid-feedback">{{ user_form.first_name.errors|first }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ user_form.last_name.id_for_label }}" class="form-label">{{ user_form.last_name.label }}</label>
                                {{ user_form.last_name }}
                                {% if user_form.last_name.errors %}<div class="invalid-feedback">{{ user_form.last_name.errors|first }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ user_form.email.id_for_label }}" class="form-label">{{ user_form.email.label }}</label>
                            {{ user_form.email }}
                            {% if user_form.email.errors %}<div class="invalid-feedback">{{ user_form.email.errors|first }}</div>{% endif %}
                        </div>

                        <hr class="my-4">

                        <h4 class="h5 mb-3">Datos Profesionales</h4>
                        <div class="mb-3">
                            <label for="{{ doctor_form.rut.id_for_label }}" class="form-label">{{ doctor_form.rut.label }}</label>
                            {{ doctor_form.rut }}
                            {% if doctor_form.rut.errors %}<div class="invalid-feedback">{{ doctor_form.rut.errors|first }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ doctor_form.fecha_nacimiento.id_for_label }}" class="form-label">{{ doctor_form.fecha_nacimiento.label }}</label>
                            {# Añadir un atributo de clase para el widget de fecha #}
                            {{ doctor_form.fecha_nacimiento }}
                            {% if doctor_form.fecha_nacimiento.errors %}<div class="invalid-feedback">{{ doctor_form.fecha_nacimiento.errors|first }}</div>{% endif %}
                        </div>
                        <div class="mb-4">
                            <label for="{{ doctor_form.foto_perfil.id_for_label }}" class="form-label">{{ doctor_form.foto_perfil.label }}</label>
                            {{ doctor_form.foto_perfil }}
                            {% if doctor_form.foto_perfil.errors %}<div class="invalid-feedback">{{ doctor_form.foto_perfil.errors|first }}</div>{% endif %}
                            {% if doctor_form.instance.foto_perfil %}
                             <small class="form-text text-muted d-block mt-1">Archivo actual: {{ doctor_form.instance.foto_perfil.name }}</small>
                            {% endif %}
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-pink-gradient btn-lg">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}